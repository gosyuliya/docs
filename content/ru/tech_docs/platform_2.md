---
title: "Описание протокола CAN и стека CANopen"
slug: "pl_2"
description: "для разработчиков встраиваемых систем"
weight: 2
---

# Введение
## Назначение документа

Документ предназначен для разработчиков Embedded-систем, впервые сталкивающихся с протоколом CAN и стеком CANopen.

Цель -- сформировать целостное понимание архитектуры обмена, механизмов работы шины и прикладной модели устройств.

## Область применения

Материал ориентирован на разработку:
- микроконтроллерных устройств;
- промышленных модулей ввода-вывода;
- приводной техники;
- распределённых систем управления.

# Протокол CAN

CAN (Controller Area Network) -- промышленная последовательная шина, стандартизованная ISO (ISO 11898). Протокол обеспечивает обмен короткими сообщениями между узлами без центрального управляющего устройства.

## Назначение и области применения

Основная задача CAN -- надёжная передача данных в распределённых системах реального времени.

Ключевые свойства:
- отсутствие мастера;
- детерминированный доступ к среде;
- высокая помехоустойчивость;
- встроенные механизмы обнаружения ошибок;
- аппаратная поддержка в большинстве микроконтроллеров.

CAN широко применяется в автомобильной электронике, промышленной автоматике, медицинском оборудовании и робототехнике.

## Используемые уровни OSI

CAN реализует только нижние уровни модели OSI.

Таблица 1 -- Соответствие CAN уровням OSI
<table>
    <tr>
        <th style="text-align: center; vertical-align: center;">Уровень OSI</th>
        <th style="text-align: center; vertical-align: center;">Реализация в CAN</th>
    </tr>
    <tr>
        <td>7–3</td>
        <td>Не определены стандартом</td>
    </tr>
    <tr>
        <td>2 (Data Link)</td>
        <td>Формирование кадра, арбитрация, контроль ошибок</td>
    </tr>
    <tr>
        <td>1 (Physical)</td>
        <td>Электрические параметры, дифференциальная линия CAN_H / CAN_L</td>
    </tr>
 </table> 

Прикладной уровень в стандарт CAN не входит.

## Структура фрейма

В классическом CAN полезная нагрузка составляет до 8 байт. Поддерживаются стандартный (11-битный) и расширенный (29-битный) идентификаторы.

Упрощённая структура стандартного кадра:

```mermaid
flowchart LR
    SOF --> Identifier --> Control --> Data --> CRC --> ACK --> EOF

```
Таблица 2 -- Основные поля CAN-кадра
<table>
    <tr>
        <th style="text-align: center; vertical-align: center;">Поле</th>
        <th style="text-align: center; vertical-align: center;">Назначение</th>
    </tr>
    <tr>
        <td>SOF</td>
        <td>Признак начала кадра</td>
    </tr>
    <tr>
        <td>Identifier</td>
        <td>Приоритет и логическая идентификация сообщения</td>
    </tr>
    <tr>
        <td>Control</td>
        <td>Служебные биты и длина данных (DLC)</td>
    </tr>
    <tr>
        <td>Data</td>
        <td>Полезная нагрузка</td>
    </tr>
    <tr>
        <td>CRC</td>
        <td>Контроль целостности</td>
    </tr>
    <tr>
        <td>ACK</td>
        <td>Подтверждение приёма</td>
    </tr>
    <tr>
        <td>EOF</td>
        <td>Завершение кадра</td>
    </tr>
 </table> 

Идентификатор определяет приоритет сообщения и участвует в механизме арбитрации.

## Механизм арбитрации

CAN использует побитовую арбитрацию без разрушения передачи.

Передача осуществляется с использованием доминантного (0) и рецессивного (1) уровней.
Если узел передаёт рецессивный бит, но фиксирует на линии доминантный, он прекращает передачу.

Выигрывает сообщение с меньшим числовым значением идентификатора.

Следствие для проектирования: схема идентификаторов должна разрабатываться на этапе архитектуры системы, поскольку она определяет приоритеты сообщений.

## Обнаружение и обработка ошибок

CAN содержит встроенные механизмы контроля:
- проверка CRC;
- контроль формата кадра;
- подтверждение приёма (ACK);
- контроль бит-стаффинга.

Каждый узел ведёт счётчики ошибок передачи (TEC) и приёма (REC).

Таблица 3 — Состояния узла CAN
<table>
    <tr>
        <th style="text-align: center; vertical-align: center;">Состояние</th>
        <th style="text-align: center; vertical-align: center;">Характеристика</th>
    </tr>
    <tr>
        <td>Error Active</td>
        <td>Нормальный режим работы</td>
    </tr>
    <tr>
        <td>Error Passive</td>
        <td>Повышенный уровень ошибок</td>
    </tr>
    <tr>
        <td>Bus Off</td>
        <td>отключён от шины</td>
    </tr>
 </table> 

Состояние Bus Off предотвращает блокировку сети неисправным устройством.

# Стек CANopen

CANopen -- прикладной протокол поверх CAN, разработанный ассоциацией CAN in Automation (CiA).\
Он определяет структуру данных, поведение узлов и правила конфигурации.

## Назначение стека CANopen

CANopen обеспечивает:
- стандартизированную модель устройства;
- управление состояниями узлов;
- конфигурацию параметров;
- передачу процессных данных;
- унифицированные профили устройств.

## Используемые уровни OSI

Таблица 4 -- Соответствие CANopen уровням OSI
<table>
    <tr>
        <th style="text-align: center; vertical-align: center;">Уровень OSI</th>
        <th style="text-align: center; vertical-align: center;">Реализация в CAN</th>
    </tr>
    <tr>
        <td>7 (Application)</td>
        <td>CANopen (SDO, PDO, NMT, EMCY)</td>
    </tr>
    <tr>
        <td>6–3</td>
        <td>Не используются</td>
    </tr>
    <tr>
        <td>2</td>
        <td>CAN</td>
    </tr>
    <tr>
        <td>1</td>
        <td>CAN</td>
    </tr>
 </table> 

CANopen полностью занимает прикладной уровень.

## Словарь объектов

Словарь объектов (Object Dictionary) -- центральная структура данных CANopen-устройства.

Каждый параметр адресуется комбинацией:
- 16-битный Index;
- 8-битный Subindex.

Словарь включает:
- параметры идентификации;
- коммуникационные настройки;
- конфигурационные параметры;
- процессные данные.

Таблица 5 -- Типовые диапазоны индексов
<table>
    <tr>
        <th style="text-align: center; vertical-align: center;">Диапазон</th>
        <th style="text-align: center; vertical-align: center;">Назначение</th>
    </tr>
    <tr>
        <td>0x1000–0x1FFF</td>
        <td>Коммуникационные параметры</td>
    </tr>
    <tr>
        <td>0x2000–0x5FFF</td>
        <td>Параметры производителя</td>
    </tr>
    <tr>
        <td>0x6000 и выше</td>
        <td>Профили устройств</td>
 </table>

Доступ к словарю осуществляется через SDO или автоматически через PDO.

## Типы объектов коммуникации

Таблица 6 -- Основные типы объектов CANopen
<table>
    <tr>
        <th style="text-align: center; vertical-align: center;">Тип</th>
        <th style="text-align: center; vertical-align: center;">Назначение</th>
    </tr>
    <tr>
        <td>NMT</td>
        <td>Управление состояниями сети</td>
    </tr>
    <tr>
        <td>SDO</td>
        <td>Чтение и запись объектов словаря</td>
    </tr>
    <tr>
        <td>PDO</td>
        <td>Передача процессных данных в реальном времени</td>
    </tr>
    <tr>
        <td>EMCY</td>
        <td>Передача аварийных сообщений</td>
    </tr>
 </table>

PDO предназначены для быстрого обмена данными без подтверждения.
SDO используются для конфигурации и диагностики.

## Адресация узлов (Node-ID)

Каждому устройству присваивается Node-ID в диапазоне 1–127.
Значение 0 используется для широковещательных сообщений управления.

Идентификатор CAN формируется по принципу: *COB-ID = Function Code + Node-ID*

Так реализуется логическая адресация поверх общей физической шины.


# Глоссарий

**CAN** -- протокол канального уровня для распределённых систем реального времени.

**CANopen** -- прикладной протокол поверх CAN.

**Node-ID** -- идентификатор узла в сети CANopen.

**COB-ID** -- идентификатор CAN-сообщения в CANopen.

**PDO** -- Process Data Object, объект передачи процессных данных.

**SDO** -- Service Data Object, сервис доступа к словарю объектов.

**NMT** -- Network Management, управление состояниями узлов.

**Object Dictionary** -- структурированная таблица параметров устройства.

**Bus Off** -- режим отключения узла при критическом уровне ошибок.

---
